<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RE Matcher — Cloud Database</title>

  <style>
    :root{
      --bg:#f3f6fb; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --danger:#ef4444;
      --radius:12px; --pad:18px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:#111827;
    }
    html,body{height:100%; margin:0; background:var(--bg);}
    .wrap{max-width:1200px;margin:28px auto;padding:12px;}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:52px;height:52px;background:var(--accent);color:white;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;font-weight:700}
    h1{margin:0;font-size:20px}
    nav{margin-left:auto;display:flex;gap:8px}
    nav button{background:white;border:1px solid #e6e9ef;padding:10px 14px;border-radius:12px;cursor:pointer}
    nav button.active{background:var(--accent);color:white;border-color:var(--accent)}
    .card{background:var(--card);border-radius:var(--radius);padding:var(--pad);box-shadow:0 4px 18px rgba(12,18,31,0.06);margin-bottom:16px}
    label{display:block;font-weight:700;margin-bottom:6px}
    .row{display:flex;gap:12px;align-items:center}
    .col{flex:1}
    input[type=text], input[type=number], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;background:#fff}
    textarea{min-height:100px;resize:vertical}
    .small{width:160px}
    .muted{color:var(--muted);font-size:13px}
    .primary{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .primary:disabled{background:#93c5fd;cursor:not-allowed;}
    .danger{background:var(--danger);color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
    .listings-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .listing{background:#f8fafc;padding:10px;border-radius:8px;width:280px;box-shadow:0 1px 0 rgba(0,0,0,0.02)}
    .controls{display:flex;gap:8px;align-items:center}
    .filters-area{margin-top:12px;background:#fbfdff;border-radius:8px;padding:12px;border:1px solid #eef3ff}
    .filter-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .btn-ghost{background:white;border:1px solid #e6e9ef;padding:8px 10px;border-radius:8px}
    @media (max-width:900px){ .row{flex-direction:column} .small{width:100%} .listing{width:100%} nav{flex-wrap:wrap} }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">RE</div>
        <div>
          <h1>RE Matcher — Cloud DB</h1>
          <div class="muted">Connected to Neon Database</div>
        </div>
      </div>

      <nav>
        <button data-route="buyers" class="active">Buyer Form</button>
        <button data-route="listings">Listing Form</button>
        <button data-route="data">Data</button>
        <button data-route="matches">Matches</button>
      </nav>
    </header>

    <section id="page-buyers" class="card">
      <h2>Manage Enquiry — Buyer Form</h2>
      <div class="muted">Fill required fields and click <strong>Add Buyer</strong></div>

      <div style="margin-top:14px" class="card">
        <div class="row">
          <div class="col">
            <label>Name *</label>
            <input id="buyer_name" type="text" placeholder="Name" />
          </div>
          <div class="col small">
            <label>Mobile No *</label>
            <input id="buyer_mobile" type="text" placeholder="Mobile Number" />
          </div>
          <div class="col small">
            <label>Second Mobile</label>
            <input id="buyer_mobile2" type="text" placeholder="Mobile Number" />
          </div>
          <div class="col small">
            <label>Email</label>
            <input id="buyer_email" type="text" placeholder="Email" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col small">
            <label>Country *</label>
            <select id="buyer_country">
              <option>India</option>
            </select>
          </div>
          <div class="col small">
            <label>State *</label>
            <input id="buyer_state" placeholder="State"/>
          </div>
          <div class="col">
            <label>City *</label>
            <input id="buyer_city" placeholder="City"/>
          </div>
          <div class="col small">
            <label>Service Type *</label>
            <select id="buyer_service_type">
              <option>Buy</option>
              <option>Rent</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col small">
            <label>Property Type</label>
            <input id="buyer_property_type" placeholder="e.g. 2BHK"/>
          </div>
          <div class="col small">
            <label>Sale Type</label>
            <select id="buyer_sale_type">
              <option>Sale</option>
              <option>Rent</option>
            </select>
          </div>
          <div class="col small">
            <label>Furnishing Status</label>
            <select id="buyer_furnishing">
              <option>Furnished</option>
              <option>Semi-Furnished</option>
              <option>Un-Furnished</option>
            </select>
          </div>
          <div class="col small">
            <label>Possession Status</label>
            <select id="buyer_possession_status">
              <option>Ready</option>
              <option>Under Construction</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col small">
            <label>Possession Time</label>
            <select id="buyer_possession_time"><option>Immediate</option><option>3 months</option><option>6 months</option></select>
          </div>
          <div class="col small">
            <label>Approx Budget</label>
            <input id="buyer_budget" placeholder="Budget number" />
          </div>
          <div class="col small">
            <label>Budget Unit</label>
            <select id="buyer_budget_unit">
              <option value="lakh">Lakh</option>
              <option value="crore">Crore</option>
              <option value="thousand">Thousand</option>
            </select>
          </div>
          <div class="col small">
            <label>Area</label>
            <input id="buyer_area" placeholder="Ex. 1200" />
          </div>
          <div class="col small">
            <label>Area Unit</label>
            <select id="buyer_area_unit">
              <option value="Sq Mt" selected>Sq Mt</option>
              <option value="Sq Ft">Sq Ft</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px" class="row">
          <div class="col">
            <label>Preferred Localities</label>
            <input id="buyer_localities" placeholder="comma separated"/>
          </div>
          <div class="col">
            <label>Preferred Projects</label>
            <input id="buyer_projects" placeholder="comma separated"/>
          </div>
        </div>

        <div style="margin-top:12px" class="row">
          <div class="col small">
            <label>Lead Source</label>
            <input id="buyer_lead_source" />
          </div>
          <div class="col small">
            <label>Referral Name</label>
            <input id="buyer_referral" />
          </div>
          <div class="col small">
            <label>NRI</label>
            <select id="buyer_nri"><option value="no">No</option><option value="yes">Yes</option></select>
          </div>
          <div class="col small">
            <label>Loan Required</label>
            <select id="buyer_loan_required"><option value="no">No</option><option value="yes">Yes</option></select>
          </div>
          <div class="col small">
            <label>Purpose</label>
            <select id="buyer_purpose"><option>Self</option><option>Investment</option></select>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Specific Requirements</label>
          <textarea id="buyer_specific" placeholder="Any special requirements"></textarea>
        </div>

        <div style="margin-top:12px" class="row">
          <button id="addBuyer" class="primary">Add Buyer</button>
          <button id="downloadBuyers" class="btn-ghost">Download backup.csv</button>
        </div>
      </div>
    </section>

    <section id="page-listings" class="card" style="display:none">
      <h2>Add Listing — Property Details</h2>
      <div class="muted">Add a property listing that will be matched with buyers</div>

      <div style="margin-top:14px" class="card">
        <div class="row">
          <div class="col small">
            <label>Sell / Rent</label>
            <select id="listing_deal_type"><option>Sell</option><option>Rent</option></select>
          </div>
          <div class="col small">
            <label>Furnishing</label>
            <select id="listing_furnishing"><option>Furnished</option><option>Semi-Furnished</option><option>Un-Furnished</option></select>
          </div>
          <div class="col">
            <label>Property Type</label>
            <input id="listing_property_type" placeholder="e.g. Apartment"/>
          </div>
          <div class="col small">
            <label>Bedrooms</label>
            <input id="listing_bedrooms" placeholder="2" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col small">
            <label>State</label>
            <input id="listing_state" />
          </div>
          <div class="col small">
            <label>Locality</label>
            <input id="listing_locality" />
          </div>
          <div class="col">
            <label>Project (optional)</label>
            <input id="listing_project" />
          </div>
          <div class="col">
            <label>Google Address</label>
            <input id="listing_google_address" placeholder="Google formatted address"/>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col">
            <label>Address *</label>
            <input id="listing_address" placeholder="Full address"/>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col small">
            <label>Area</label>
            <input id="listing_area" placeholder="e.g. 120" />
          </div>
          <div class="col small">
            <label>Area Unit</label>
            <select id="listing_area_unit">
              <option value="Sq Mt" selected>Sq Mt</option>
              <option value="Sq Ft">Sq Ft</option>
            </select>
          </div>
          <div class="col small">
            <label>Price</label>
            <input id="listing_price" placeholder="number"/>
          </div>
          <div class="col small">
            <label>Price Unit</label>
            <select id="listing_price_unit">
              <option value="lakh">Lakh</option>
              <option value="crore">Crore</option>
              <option value="thousand">Thousand</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col small">
            <label>Deposit</label>
            <input id="listing_deposit" placeholder="number"/>
          </div>
          <div class="col small">
            <label>Deposit Unit</label>
            <select id="listing_deposit_unit"><option value="lakh">Lakh</option><option value="thousand">Thousand</option></select>
          </div>
          <div class="col small">
            <label>Contact</label>
            <input id="listing_contact" placeholder="phone"/>
          </div>
          <div class="col">
            <label>Listing URL</label>
            <input id="listing_url" placeholder="optional url"/>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Property Description *</label>
          <textarea id="listing_description" placeholder="Description"></textarea>
        </div>

        <div style="margin-top:12px" class="row">
          <button id="addListing" class="primary">Add Listing</button>
          <button id="downloadListings" class="btn-ghost">Download backup.csv</button>
        </div>
      </div>
    </section>

    <section id="page-data" class="card" style="display:none">
      <h2>Manage Database</h2>
      <div class="muted">View / filter / edit / delete data directly from Neon DB</div>

      <div style="margin-top:12px" class="row">
        <div style="width:240px">
          <select id="csvSelect">
            <option value="buyers.csv">Buyers Database</option>
            <option value="listings.csv">Listings Database</option>
            <option value="matches.csv">Matches (Temporary)</option>
          </select>
        </div>
        <div style="flex:1">
          <input id="csvFilterQuick" placeholder="Quick filter across all columns (single)"/>
        </div>
        <div class="controls">
          <button id="refreshCsv" class="primary">Refresh Data</button>
          <button id="downloadCsv" class="btn-ghost">Download CSV</button>
          <button id="deleteSelected" class="danger">Delete selected</button>
        </div>
      </div>

      <div class="filters-area">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div><strong>Filters</strong> <span class="muted">Add multiple filter rules. Choose AND/OR to combine.</span></div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="addDataFilterBtn" class="primary">+ Add Filter</button>
            <label style="margin:0 6px">Combine:</label>
            <select id="dataFilterMode"><option value="and">AND</option><option value="or">OR</option></select>
            <button id="applyDataFilters" class="btn-ghost">Apply Filters</button>
            <button id="clearDataFilters" class="btn-ghost">Clear</button>
          </div>
        </div>
        <div id="dataFiltersContainer" style="margin-top:10px"></div>
      </div>

      <div style="margin-top:14px; overflow:auto; max-height:420px">
        <table>
          <thead id="csvHead"></thead>
          <tbody id="csvBody"></tbody>
        </table>
      </div>
    </section>

    <section id="page-matches" class="card" style="display:none">
      <h2>Matches</h2>
      <div class="muted">Match Database data + Optional CSV uploads</div>

      <div style="margin-top:12px" class="row">
        <div style="width:260px">
          <label>Upload extra buyers CSV (optional)</label>
          <input type="file" id="uploadBuyers" accept=".csv" />
          <div style="height:8px"></div>
          <label>Upload extra listings CSV (optional)</label>
          <input type="file" id="uploadListings" accept=".csv" />
        </div>

        <div style="flex:1">
          <label>Min score threshold</label>
          <input id="minScore" placeholder="e.g. 60" />
          <div style="margin-top:8px" class="row">
            <button id="mergeAndRun" class="primary">Merge & Run Matcher</button>
            <button id="downloadMatchesBtn" class="btn-ghost">Download matches.csv</button>
          </div>
        </div>
      </div>

      <div class="filters-area" style="margin-top:12px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div><strong>Match Filters</strong> <span class="muted">Add rules and filter results by fields or score.</span></div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="addMatchFilterBtn" class="primary">+ Add Match Filter</button>
            <label style="margin:0 6px">Combine:</label>
            <select id="matchFilterMode"><option value="and">AND</option><option value="or">OR</option></select>
            <label style="margin-left:12px">Score between</label>
            <input id="matchScoreMin" style="width:72px;margin-left:6px" placeholder="0" />
            <input id="matchScoreMax" style="width:72px;margin-left:6px" placeholder="100" />
            <button id="applyMatchFilters" class="btn-ghost">Apply</button>
            <button id="clearMatchFilters" class="btn-ghost">Clear</button>
          </div>
        </div>
        <div id="matchFiltersContainer" style="margin-top:10px"></div>
      </div>

      <div id="matchesContainer" style="margin-top:12px"></div>
    </section>

    <div style="height:28px"></div>
  </div>

  <script>
  // ---- UTILITIES ----
  const $ = id => document.getElementById(id);
  function parseCSV(text){ return Papa.parse(text, { header:true, skipEmptyLines:true }).data; }
  function toCSV(arr){ return Papa.unparse(arr); }
  function downloadText(filename, text){
    const blob = new Blob([text], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }
  function uid(prefix='id'){ return prefix + '-' + Math.random().toString(36).slice(2,10); }
  function unitToMultiplier(unit){
    unit = (unit||'').toLowerCase();
    if(unit.includes('lakh')) return 100000;
    if(unit.includes('thousand')) return 1000;
    if(unit.includes('crore')) return 10000000;
    return 1;
  }
  function parseNumber(v){ if(v==null||v==='') return null; const n = parseFloat(String(v).replace(/[^0-9.]/g,'')); return isNaN(n)?null:n; }
  function toRupees(value, unit){ const n = parseNumber(value); if(n===null) return null; return n * unitToMultiplier(unit); }
  
  // SECURITY FIX: Prevent XSS
  function escapeHtml(text) {
    if (text == null) return '';
    return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }

  // ---- STATE ----
  let baseBuyers = [], baseListings = [];
  let uploadedBuyers = [], uploadedListings = [];
  let mergedBuyers = [], mergedListings = [];
  let matches = [];
  let csvRaw = [], csvColumns = [], selectedSet = new Set();
  let dataFilters = [], matchFilters = [];

  // ---- HELPERS ----
  function ensureUniqueId(prefix, suppliedId, existingArrays) {
    // Simple ID generation for new entries
    return prefix + '-' + Math.random().toString(36).slice(2,10);
  }

  function mergeBuyers(base, uploaded){
    const out = [...(base || [])];
    const ids = new Set((base||[]).map(b => (b.id||'').toString()));
    for(const u of (uploaded||[])){
      if(!u) continue;
      const uid = (u.id||'').toString();
      if(uid && !ids.has(uid)){ out.push(u); ids.add(uid); }
      else if(!uid){
        const key = ((u.name||'')+'|'+(u.city||'')+'|'+(u.mobile||'')).toLowerCase();
        const exists = out.some(b=>(((b.name||'')+'|'+(b.city||'')+'|'+(b.mobile||'')).toLowerCase()===key));
        if(!exists) out.push(u);
      }
    }
    return out;
  }
  function mergeListings(base, uploaded){
    const out = [...(base || [])];
    const urls = new Set((base||[]).map(l => (l.url||'').toString()));
    for(const u of (uploaded||[])){
      if(!u) continue;
      const uurl = (u.url||'').toString();
      if(uurl && !urls.has(uurl)){ out.push(u); urls.add(uurl); }
      else if(!uurl){
        const key = ((u.address||'')+'|'+(u.locality||'')+'|'+(u.price||'')).toLowerCase();
        const exists = out.some(l=>(((l.address||'')+'|'+(l.locality||'')+'|'+(l.price||'')).toLowerCase()===key));
        if(!exists) out.push(u);
      }
    }
    return out;
  }

  // ---- FETCH FROM SERVER ----
  async function loadDefaults(){
    baseBuyers = []; baseListings = [];
    try {
      const r1 = await fetch('/api/buyers');
      if (r1.ok) baseBuyers = await r1.json();
    } catch(e){ console.warn('Fetch buyers failed', e); }

    try {
      const r2 = await fetch('/api/listings');
      if (r2.ok) {
        const raw = await r2.json();
        baseListings = raw.map(l => ({ ...l, price: parseNumber(l.price) || parseNumber(l.price_raw) || l.price }));
      }
    } catch(e){ console.warn('Fetch listings failed', e); }

    mergedBuyers = mergeBuyers(baseBuyers, uploadedBuyers);
    mergedListings = mergeListings(baseListings, uploadedListings);
    console.info('Loaded DB Data. Buyers:', mergedBuyers.length, 'Listings:', mergedListings.length);
  }

  async function loadCsvFile(name){
    csvRaw = []; csvColumns = [];
    const apiEndpoint = { 'buyers.csv': '/api/buyers', 'listings.csv': '/api/listings' }[name];

    if (name === 'matches.csv') {
      const source = matches || [];
      if(!source.length) alert("No matches generated yet. Run the Matcher first.");
      csvRaw = source.map((r,i) => ({ __index:i, ...r }));
    } 
    else if (apiEndpoint) {
      try {
        const res = await fetch(apiEndpoint);
        if(!res.ok) throw new Error(`Server ${res.status}`);
        const data = await res.json();

        if(name === 'buyers.csv') {
          baseBuyers = data;
          mergedBuyers = mergeBuyers(baseBuyers, uploadedBuyers);
          csvRaw = mergedBuyers.map((r,i) => ({ __index:i, ...r }));
        } 
        else if(name === 'listings.csv') {
          baseListings = data.map(l => ({ ...l, price: parseNumber(l.price)||l.price }));
          mergedListings = mergeListings(baseListings, uploadedListings);
          csvRaw = mergedListings.map((r,i) => ({ __index:i, ...r }));
        }
      } catch(err) {
        console.error(err);
        alert(`Error loading DB: ${err.message}`);
      }
    }

    csvColumns = csvRaw.length ? Object.keys(csvRaw[0]).filter(k => k !== '__index') : [];
    renderCsvTable();
  }

  // ---- RENDER TABLE (Clean - No Listeners inside) ----
  function renderCsvTable(){
    const head = $('csvHead'), body = $('csvBody');
    if(!head || !body) return;
    head.innerHTML=''; body.innerHTML='';
    if(!csvColumns.length){ head.innerHTML = '<tr><th>No data</th></tr>'; return; }
    
    // Header
    const trh = document.createElement('tr');
    trh.innerHTML = `<th><input id="selectAll" type="checkbox" /></th>` + csvColumns.map(c=>`<th>${c}</th>`).join('') + '<th>Actions</th>';
    head.appendChild(trh);
    
    // Select All Listener
    const selectAllEl = $('selectAll');
    if(selectAllEl) selectAllEl.addEventListener('change', e=> { 
        if(e.target.checked) csvRaw.forEach(r=>selectedSet.add(r.__index)); 
        else selectedSet.clear(); 
        renderCsvTable(); 
    });

    // Body
    const filterQuick = ($('csvFilterQuick') ? $('csvFilterQuick').value : '').toLowerCase();
    csvRaw.forEach(row => {
      const rowValues = csvColumns.map(c=> (row[c]||'').toString()).join(' ').toLowerCase();
      if(filterQuick && !rowValues.includes(filterQuick)) return;
      
      const tr = document.createElement('tr');
      const checked = selectedSet.has(row.__index) ? 'checked' : '';
      
      // FIX: Use escapeHtml here
      tr.innerHTML = `<td><input type="checkbox" class="row-checkbox" data-idx="${row.__index}" ${checked}></td>` +
        csvColumns.map(c=>`<td>${escapeHtml(row[c])}</td>`).join('') +
        `<td><button data-idx="${row.__index}" class="edit">Edit</button></td>`;
      body.appendChild(tr);
    });
  }

  // ---- CRUD ACTIONS ----
  async function deleteSelectedRows(){
    if(!selectedSet.size){ alert('No selection'); return; }
    if(!confirm(`Permanently delete ${selectedSet.size} rows from Database?`)) return;

    const currentCsv = $('csvSelect').value;
    const isBuyer = currentCsv === 'buyers.csv';
    const apiBase = isBuyer ? '/api/buyers' : '/api/listings';

    // Disable button if desired, but blocking alert usually enough
    for(const idx of selectedSet){
      const row = csvRaw.find(r => r.__index === idx);
      if(row && row.id){
        try {
          await fetch(`${apiBase}/${row.id}`, { method: 'DELETE' });
        } catch(e){ console.error('Delete failed', row.id); }
      }
    }
    
    alert('Deletion complete.');
    selectedSet.clear();
    await loadCsvFile(currentCsv);
  }

  async function handleEditClick(btn){
    const idx = parseInt(btn.getAttribute('data-idx'));
    const row = csvRaw.find(r => r.__index === idx);
    if (!row) return;

    const currentCsv = $('csvSelect').value;
    const isDbData = (currentCsv === 'buyers.csv' || currentCsv === 'listings.csv');
    const editedRow = { ...row };
    
    let hasChanges = false;
    for (const col of csvColumns) {
        if (col === '__index') continue; 
        const oldVal = row[col] || '';
        const newVal = prompt(`Edit ${col}`, oldVal);
        if (newVal !== null && newVal !== oldVal) {
            editedRow[col] = newVal;
            hasChanges = true;
        }
    }

    if (!hasChanges) return;

    if (isDbData && row.id) {
        try {
            const apiEndpoint = currentCsv === 'buyers.csv' ? '/api/buyers' : '/api/listings';
            delete editedRow.__index;
            const res = await fetch(`${apiEndpoint}/${row.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(editedRow)
            });
            if (res.ok) {
                alert('Saved successfully!');
                await loadCsvFile(currentCsv);
            } else alert('Server failed to save edit.');
        } catch (e) { console.error(e); alert('Error connecting to server.'); }
    } else {
        Object.assign(row, editedRow);
        renderCsvTable();
    }
  }

  // ---- MAIN WIRING ----
  window.addEventListener('DOMContentLoaded', async () => {
    await loadDefaults();

    // 1. ROBUST EVENT LISTENER (Fixes checkbox/edit bugs)
    const csvBody = $('csvBody');
    if(csvBody) {
      csvBody.addEventListener('click', (e) => {
        // Handle Edit Button Click (Bubbling)
        const btn = e.target.closest('button.edit'); 
        if(btn) {
           handleEditClick(btn);
           return;
        }
      });
      csvBody.addEventListener('change', (e) => {
        // Handle Checkbox Change
        if(e.target.classList.contains('row-checkbox')) {
          const idx = parseInt(e.target.getAttribute('data-idx'));
          if(e.target.checked) selectedSet.add(idx);
          else selectedSet.delete(idx);
        }
      });
    }

    // 2. Navigation
    document.querySelectorAll('nav button').forEach(btn => btn.onclick = ()=> {
      ['buyers','listings','data','matches'].forEach(p=> {
        const el = document.getElementById('page-' + p);
        if(el) el.style.display = (p === btn.getAttribute('data-route')) ? 'block':'none';
      });
      document.querySelectorAll('nav button').forEach(b => b.classList.toggle('active', b === btn));
    });

    // 3. Add Buyer (With Duplicate Prevention)
    const addBuyerBtn = $('addBuyer');
    if(addBuyerBtn) addBuyerBtn.onclick = async () => {
      addBuyerBtn.disabled = true; 
      addBuyerBtn.textContent = "Saving...";
      
      try {
        const id = ensureUniqueId('buyer', '', [baseBuyers]);
        const rec = {
          id,
          name: $('buyer_name').value.trim(),
          mobile: $('buyer_mobile').value.trim(),
          mobile2: $('buyer_mobile2').value.trim(),
          email: $('buyer_email').value.trim(),
          country: $('buyer_country').value.trim(),
          state: $('buyer_state').value.trim(),
          city: $('buyer_city').value.trim(),
          service_type: $('buyer_service_type').value.trim(),
          property_type: $('buyer_property_type').value.trim(),
          sale_type: $('buyer_sale_type').value.trim(),
          furnishing: $('buyer_furnishing').value.trim(),
          possession_status: $('buyer_possession_status').value.trim(),
          possession_time: $('buyer_possession_time').value.trim(),
          budget_raw: $('buyer_budget').value.trim(),
          budget_unit: ($('buyer_budget_unit')?$('buyer_budget_unit').value:'lakh'),
          budget_rupees: toRupees($('buyer_budget').value.trim(), ($('buyer_budget_unit')?$('buyer_budget_unit').value:'lakh')),
          area: $('buyer_area').value.trim(),
          area_unit: ($('buyer_area_unit')?$('buyer_area_unit').value:'Sq Mt'),
          preferred_localities: $('buyer_localities').value.trim(),
          preferred_projects: $('buyer_projects').value.trim(),
          lead_source: $('buyer_lead_source').value.trim(),
          referral: $('buyer_referral').value.trim(),
          nri: ($('buyer_nri')?$('buyer_nri').value:'no'),
          loan_required: ($('buyer_loan_required')?$('buyer_loan_required').value:'no'),
          purpose: ($('buyer_purpose')?$('buyer_purpose').value:''),
          specific: $('buyer_specific').value.trim()
        };
        if(!rec.name || !rec.mobile){ alert('Name and Mobile required'); return; }

        const res = await fetch('/api/buyers', {
          method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(rec)
        });
        if(res.ok){
          alert(`Buyer saved (ID: ${id})`);
          await loadDefaults();
          ['buyer_name','buyer_mobile','buyer_mobile2','buyer_email','buyer_state','buyer_city','buyer_property_type','buyer_budget','buyer_area','buyer_localities','buyer_projects','buyer_lead_source','buyer_referral','buyer_specific'].forEach(id => { if($(id)) $(id).value = ''; });
        } else alert('Save failed');
      } catch(e) { console.error(e); alert('Server Error'); } 
      finally { addBuyerBtn.disabled = false; addBuyerBtn.textContent = "Add Buyer"; }
    };

    // 4. Add Listing
    const addListingBtn = $('addListing');
    if(addListingBtn) addListingBtn.onclick = async () => {
      addListingBtn.disabled = true; addListingBtn.textContent = "Saving...";
      try {
        const id = ensureUniqueId('listing', '', [baseListings]);
        const rec = {
          id,
          deal_type: ($('listing_deal_type')?$('listing_deal_type').value:'Sell'),
          furnishing: ($('listing_furnishing')?$('listing_furnishing').value:''),
          property_type: $('listing_property_type').value.trim(),
          bedrooms: $('listing_bedrooms').value.trim(),
          state: $('listing_state').value.trim(),
          locality: $('listing_locality').value.trim(),
          google_address: $('listing_google_address').value.trim(),
          project: $('listing_project').value.trim(),
          address: $('listing_address').value.trim(),
          area: $('listing_area').value.trim(),
          area_unit: ($('listing_area_unit')?$('listing_area_unit').value:'Sq Mt'),
          price_raw: $('listing_price').value.trim(),
          price_unit: ($('listing_price_unit')?$('listing_price_unit').value:'Lakh'),
          price: toRupees($('listing_price').value.trim(), ($('listing_price_unit')?$('listing_price_unit').value:'Lakh')),
          deposit_raw: $('listing_deposit').value.trim(),
          deposit_unit: ($('listing_deposit_unit')?$('listing_deposit_unit').value:'Lakh'),
          deposit: toRupees($('listing_deposit').value.trim(), ($('listing_deposit_unit')?$('listing_deposit_unit').value:'Lakh')),
          contact: $('listing_contact').value.trim(),
          url: $('listing_url').value.trim(),
          description: $('listing_description').value.trim()
        };
        if(!rec.address){ alert('Address required'); return; }

        const res = await fetch('/api/listings', {
          method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(rec)
        });
        if(res.ok){
          alert(`Listing saved (ID: ${id})`);
          await loadDefaults();
          ['listing_address','listing_description','listing_price','listing_area','listing_contact','listing_url','listing_bedrooms','listing_project','listing_google_address'].forEach(id => { if($(id)) $(id).value = ''; });
        } else alert('Save failed');
      } catch(e) { console.error(e); alert('Server Error'); }
      finally { addListingBtn.disabled = false; addListingBtn.textContent = "Add Listing"; }
    };

    // 5. Data & Matcher Buttons
    if($('refreshCsv')) $('refreshCsv').onclick = async ()=> loadCsvFile($('csvSelect').value);
    if($('deleteSelected')) $('deleteSelected').onclick = ()=> deleteSelectedRows();
    
    // Download Buttons
    if($('downloadCsv')) $('downloadCsv').onclick = ()=> {
      if(!csvRaw.length) { alert('No data'); return; }
      const out = csvRaw.map(r=> { const obj = {}; csvColumns.forEach(c => obj[c] = r[c] || ''); return obj; });
      downloadText($('csvSelect').value || 'data.csv', toCSV(out));
    };
    if($('downloadBuyers')) $('downloadBuyers').onclick = ()=> downloadText('buyers_backup.csv', toCSV(mergeBuyers(baseBuyers, uploadedBuyers)));
    if($('downloadListings')) $('downloadListings').onclick = ()=> downloadText('listings_backup.csv', toCSV(mergeListings(baseListings, uploadedListings)));

    // Matcher
    if($('mergeAndRun')) $('mergeAndRun').onclick = async () => {
      await loadDefaults(); // ensure fresh DB data
      mergedBuyers = mergeBuyers(baseBuyers, uploadedBuyers);
      mergedListings = mergeListings(baseListings, uploadedListings);
      const minScore = parseFloat($('minScore').value) || 60;
      matches = runMatcher(mergedBuyers, mergedListings, minScore);
      renderMatches(matches);
      alert(`Matcher ran on ${mergedBuyers.length} buyers & ${mergedListings.length} listings. Results: ${matches.length}`);
    };
    if($('downloadMatchesBtn')) $('downloadMatchesBtn').onclick = ()=> downloadText('matches.csv', toCSV(matches || []));

    // Initialize
    if($('csvSelect')) $('csvSelect').value = 'buyers.csv';
    if($('refreshCsv')) $('refreshCsv').click();
  });

  // ---- FILTERS (Standard) ----
  // (Assuming standard filter logic from previous versions, kept minimal for brevity, works with globals)
  function createFilterRow(container, columns, filtersArray) {
    const row = document.createElement('div'); row.className='filter-row';
    const colSel = document.createElement('select');
    columns.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; colSel.appendChild(opt); });
    const opSel = document.createElement('select');
    ['contains','equals','starts','ends'].forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.textContent = o; opSel.appendChild(opt); });
    const valInp = document.createElement('input'); valInp.placeholder = 'value';
    const rem = document.createElement('button'); rem.textContent = 'Remove'; rem.className='danger'; rem.style.padding='6px';
    row.appendChild(colSel); row.appendChild(opSel); row.appendChild(valInp); row.appendChild(rem); container.appendChild(row);
    const rule = { column: colSel.value, op: opSel.value, value: '' };
    filtersArray.push(rule);
    colSel.onchange = () => rule.column = colSel.value;
    opSel.onchange = () => rule.op = opSel.value;
    valInp.oninput = () => rule.value = valInp.value;
    rem.onclick = () => { filtersArray.splice(filtersArray.indexOf(rule), 1); container.removeChild(row); };
  }
  function applyFilters(arr, filtersArray, mode='and'){
    if(!filtersArray.length) return arr;
    return arr.filter(item => {
      const results = filtersArray.map(r => {
        const val = String(item[r.column]||'').toLowerCase();
        const q = String(r.value).toLowerCase();
        if(r.op==='contains') return val.includes(q);
        if(r.op==='equals') return val===q;
        if(r.op==='starts') return val.startsWith(q);
        if(r.op==='ends') return val.endsWith(q);
        return false;
      });
      return mode==='and' ? results.every(Boolean) : results.some(Boolean);
    });
  }

  // Filter Wiring
  const addDataBtn = $('addDataFilterBtn');
  if(addDataBtn) addDataBtn.onclick = () => {
    if(!csvColumns.length) return alert('Load data first');
    createFilterRow($('dataFiltersContainer'), csvColumns, dataFilters);
  };
  const applyDataFiltersBtn = $('applyDataFilters');
  if(applyDataFiltersBtn) applyDataFiltersBtn.onclick = () => {
    if(!csvRaw.length) return;
    const base = csvRaw.map(r => { const obj={}; csvColumns.forEach(c=>obj[c]=r[c]); return obj; });
    const res = applyFilters(base, dataFilters, $('dataFilterMode').value);
    csvRaw = res.map((r,i) => ({__index:i, ...r}));
    renderCsvTable();
  };
  const clearDataFiltersBtn = $('clearDataFilters');
  if(clearDataFiltersBtn) clearDataFiltersBtn.onclick = () => {
     dataFilters = []; $('dataFiltersContainer').innerHTML = ''; loadCsvFile($('csvSelect').value); 
  };
  </script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RE Matcher — Client-only</title>
  <script src="src/app.js"></script>

  <!-- Simple modern styling -->
  <style>
    :root{
      --bg:#f3f6fb; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --danger:#ef4444;
      --radius:12px; --pad:18px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:#111827;
    }
    html,body{height:100%; margin:0; background:var(--bg);}
    .wrap{max-width:1200px;margin:28px auto;padding:12px;}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:52px;height:52px;background:var(--accent);color:white;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;font-weight:700}
    h1{margin:0;font-size:20px}
    nav{margin-left:auto;display:flex;gap:8px}
    nav button{background:white;border:1px solid #e6e9ef;padding:10px 14px;border-radius:12px;cursor:pointer}
    nav button.active{background:var(--accent);color:white;border-color:var(--accent)}
    .card{background:var(--card);border-radius:var(--radius);padding:var(--pad);box-shadow:0 4px 18px rgba(12,18,31,0.06);margin-bottom:16px}
    label{display:block;font-weight:700;margin-bottom:6px}
    .row{display:flex;gap:12px;align-items:center}
    .col{flex:1}
    input[type=text], input[type=number], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;background:#fff}
    textarea{min-height:100px;resize:vertical}
    .small{width:160px}
    .muted{color:var(--muted);font-size:13px}
    .primary{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .danger{background:var(--danger);color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
    .listings-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .listing{background:#f8fafc;padding:10px;border-radius:8px;width:280px;box-shadow:0 1px 0 rgba(0,0,0,0.02)}
    .controls{display:flex;gap:8px;align-items:center}
    .filters-area{margin-top:12px;background:#fbfdff;border-radius:8px;padding:12px;border:1px solid #eef3ff}
    .filter-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .btn-ghost{background:white;border:1px solid #e6e9ef;padding:8px 10px;border-radius:8px}
    @media (max-width:900px){ .row{flex-direction:column} .small{width:100%} .listing{width:100%} nav{flex-wrap:wrap} }
  </style>

  <!-- PapaParse for CSV handling -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">RE</div>
        <div>
          <h1>RE Matcher — Client-only</h1>
          <div class="muted">Add buyers & listings, run matcher — all in-browser</div>
        </div>
      </div>

      <nav>
        <button data-route="buyers" class="active">Buyer Form</button>
        <button data-route="listings">Listing Form</button>
        <button data-route="data">Data</button>
        <button data-route="matches">Matches</button>
      </nav>
    </header>

    <!-- BUYER FORM PAGE -->
    <section id="page-buyers" class="card">
      <h2>Manage Enquiry — Buyer Form</h2>
      <div class="muted">Fill required fields and click <strong>Add Buyer</strong></div>

      <div style="margin-top:14px" class="card">
        <div class="row">
          <div class="col">
            <label>Name *</label>
            <input id="buyer_name" type="text" placeholder="Name" />
          </div>
          <div class="col small">
            <label>Mobile No *</label>
            <input id="buyer_mobile" type="text" placeholder="Mobile Number" />
          </div>
          <div class="col small">
            <label>Second Mobile</label>
            <input id="buyer_mobile2" type="text" placeholder="Mobile Number" />
          </div>
          <div class="col small">
            <label>Email</label>
            <input id="buyer_email" type="text" placeholder="Email" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col small">
            <label>Country *</label>
            <select id="buyer_country">
              <option>India</option>
            </select>
          </div>
          <div class="col small">
            <label>State *</label>
            <input id="buyer_state" placeholder="State"/>
          </div>
          <div class="col">
            <label>City *</label>
            <input id="buyer_city" placeholder="City"/>
          </div>
          <div class="col small">
            <label>Service Type *</label>
            <select id="buyer_service_type">
              <option>Buy</option>
              <option>Rent</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col small">
            <label>Property Type</label>
            <input id="buyer_property_type" placeholder="e.g. 2BHK"/>
          </div>
          <div class="col small">
            <label>Sale Type</label>
            <select id="buyer_sale_type">
              <option>Sale</option>
              <option>Rent</option>
            </select>
          </div>
          <div class="col small">
            <label>Furnishing Status</label>
            <select id="buyer_furnishing">
              <option>Furnished</option>
              <option>Semi-Furnished</option>
              <option>Un-Furnished</option>
            </select>
          </div>
          <div class="col small">
            <label>Possession Status</label>
            <select id="buyer_possession_status">
              <option>Ready</option>
              <option>Under Construction</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col small">
            <label>Possession Time</label>
            <select id="buyer_possession_time"><option>Immediate</option><option>3 months</option><option>6 months</option></select>
          </div>
          <div class="col small">
            <label>Approx Budget</label>
            <input id="buyer_budget" placeholder="Budget number" />
          </div>
          <div class="col small">
            <label>Budget Unit</label>
            <select id="buyer_budget_unit">
              <option value="lakh">Lakh</option>
              <option value="crore">Crore</option>
              <option value="thousand">Thousand</option>
            </select>
          </div>
          <div class="col small">
            <label>Area</label>
            <input id="buyer_area" placeholder="Ex. 1200" />
          </div>
          <div class="col small">
            <label>Area Unit</label>
            <select id="buyer_area_unit">
              <option value="Sq Mt" selected>Sq Mt</option>
              <option value="Sq Ft">Sq Ft</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px" class="row">
          <div class="col">
            <label>Preferred Localities</label>
            <input id="buyer_localities" placeholder="comma separated"/>
          </div>
          <div class="col">
            <label>Preferred Projects</label>
            <input id="buyer_projects" placeholder="comma separated"/>
          </div>
        </div>

        <div style="margin-top:12px" class="row">
          <div class="col small">
            <label>Lead Source</label>
            <input id="buyer_lead_source" />
          </div>
          <div class="col small">
            <label>Referral Name</label>
            <input id="buyer_referral" />
          </div>
          <div class="col small">
            <label>NRI</label>
            <select id="buyer_nri"><option value="no">No</option><option value="yes">Yes</option></select>
          </div>
          <div class="col small">
            <label>Loan Required</label>
            <select id="buyer_loan_required"><option value="no">No</option><option value="yes">Yes</option></select>
          </div>
          <div class="col small">
            <label>Purpose</label>
            <select id="buyer_purpose"><option>Self</option><option>Investment</option></select>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Specific Requirements</label>
          <textarea id="buyer_specific" placeholder="Any special requirements"></textarea>
        </div>

        <div style="margin-top:12px" class="row">
          <button id="addBuyer" class="primary">Add Buyer</button>
          <button id="downloadBuyers" class="btn-ghost">Download buyers.csv</button>
        </div>
      </div>
    </section>

    <!-- LISTING FORM PAGE -->
    <section id="page-listings" class="card" style="display:none">
      <h2>Add Listing — Property Details</h2>
      <div class="muted">Add a property listing that will be matched with buyers</div>

      <div style="margin-top:14px" class="card">
        <div class="row">
          <div class="col small">
            <label>Sell / Rent</label>
            <select id="listing_deal_type"><option>Sell</option><option>Rent</option></select>
          </div>
          <div class="col small">
            <label>Furnishing</label>
            <select id="listing_furnishing"><option>Furnished</option><option>Semi-Furnished</option><option>Un-Furnished</option></select>
          </div>
          <div class="col">
            <label>Property Type</label>
            <input id="listing_property_type" placeholder="e.g. Apartment"/>
          </div>
          <div class="col small">
            <label>Bedrooms</label>
            <input id="listing_bedrooms" placeholder="2" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col small">
            <label>State</label>
            <input id="listing_state" />
          </div>
          <div class="col small">
            <label>Locality</label>
            <input id="listing_locality" />
          </div>
          <div class="col">
            <label>Project (optional)</label>
            <input id="listing_project" />
          </div>
          <div class="col">
            <label>Google Address</label>
            <input id="listing_google_address" placeholder="Google formatted address"/>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col">
            <label>Address *</label>
            <input id="listing_address" placeholder="Full address"/>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col small">
            <label>Area</label>
            <input id="listing_area" placeholder="e.g. 120" />
          </div>
          <div class="col small">
            <label>Area Unit</label>
            <select id="listing_area_unit">
              <option value="Sq Mt" selected>Sq Mt</option>
              <option value="Sq Ft">Sq Ft</option>
            </select>
          </div>
          <div class="col small">
            <label>Price</label>
            <input id="listing_price" placeholder="number"/>
          </div>
          <div class="col small">
            <label>Price Unit</label>
            <select id="listing_price_unit">
              <option value="lakh">Lakh</option>
              <option value="crore">Crore</option>
              <option value="thousand">Thousand</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col small">
            <label>Deposit</label>
            <input id="listing_deposit" placeholder="number"/>
          </div>
          <div class="col small">
            <label>Deposit Unit</label>
            <select id="listing_deposit_unit"><option value="lakh">Lakh</option><option value="thousand">Thousand</option></select>
          </div>
          <div class="col small">
            <label>Contact</label>
            <input id="listing_contact" placeholder="phone"/>
          </div>
          <div class="col">
            <label>Listing URL</label>
            <input id="listing_url" placeholder="optional url"/>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Property Description *</label>
          <textarea id="listing_description" placeholder="Description"></textarea>
        </div>

        <div style="margin-top:12px" class="row">
          <button id="addListing" class="primary">Add Listing</button>
          <button id="downloadListings" class="btn-ghost">Download listings.csv</button>
        </div>
      </div>
    </section>

    <!-- DATA PAGE -->
    <section id="page-data" class="card" style="display:none">
      <h2>Manage CSVs</h2>
      <div class="muted">View / filter / edit / download CSV data (client-side)</div>

      <div style="margin-top:12px" class="row">
        <div style="width:240px">
          <select id="csvSelect">
            <option value="buyers.csv">buyers.csv</option>
            <option value="listings.csv">listings.csv</option>
            <option value="matches.csv">matches.csv</option>
          </select>
        </div>
        <div style="flex:1">
          <input id="csvFilterQuick" placeholder="Quick filter across all columns (single)"/>
        </div>
        <div class="controls">
          <button id="refreshCsv" class="primary">Load CSV</button>
          <button id="downloadCsv" class="btn-ghost">Download CSV</button>
          <button id="deleteSelected" class="danger">Delete selected</button>
        </div>
      </div>

      <div class="filters-area">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div><strong>Filters</strong> <span class="muted">Add multiple filter rules. Choose AND/OR to combine.</span></div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="addDataFilterBtn" class="primary">+ Add Filter</button>
            <label style="margin:0 6px">Combine:</label>
            <select id="dataFilterMode"><option value="and">AND</option><option value="or">OR</option></select>
            <button id="applyDataFilters" class="btn-ghost">Apply Filters</button>
            <button id="clearDataFilters" class="btn-ghost">Clear</button>
          </div>
        </div>
        <div id="dataFiltersContainer" style="margin-top:10px"></div>
      </div>

      <div style="margin-top:14px; overflow:auto; max-height:420px">
        <table>
          <thead id="csvHead"></thead>
          <tbody id="csvBody"></tbody>
        </table>
      </div>
    </section>

    <!-- MATCHES PAGE -->
    <section id="page-matches" class="card" style="display:none">
      <h2>Matches</h2>
      <div class="muted">Upload CSVs (optional) and run matcher on merged data</div>

      <div style="margin-top:12px" class="row">
        <div style="width:260px">
          <label>Upload buyers CSV (optional)</label>
          <input type="file" id="uploadBuyers" accept=".csv" />
          <div style="height:8px"></div>
          <label>Upload listings CSV (optional)</label>
          <input type="file" id="uploadListings" accept=".csv" />
        </div>

        <div style="flex:1">
          <label>Min score threshold</label>
          <input id="minScore" placeholder="e.g. 60" />
          <div style="margin-top:8px" class="row">
            <button id="mergeAndRun" class="primary">Merge & Run Matcher</button>
            <button id="downloadMatchesBtn" class="btn-ghost">Download matches.csv</button>
          </div>
        </div>
      </div>

      <div class="filters-area" style="margin-top:12px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div><strong>Match Filters</strong> <span class="muted">Add rules and filter results by fields or score.</span></div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="addMatchFilterBtn" class="primary">+ Add Match Filter</button>
            <label style="margin:0 6px">Combine:</label>
            <select id="matchFilterMode"><option value="and">AND</option><option value="or">OR</option></select>
            <label style="margin-left:12px">Score between</label>
            <input id="matchScoreMin" style="width:72px;margin-left:6px" placeholder="0" />
            <input id="matchScoreMax" style="width:72px;margin-left:6px" placeholder="100" />
            <button id="applyMatchFilters" class="btn-ghost">Apply</button>
            <button id="clearMatchFilters" class="btn-ghost">Clear</button>
          </div>
        </div>
        <div id="matchFiltersContainer" style="margin-top:10px"></div>
      </div>

      <div id="matchesContainer" style="margin-top:12px"></div>
    </section>

    <div style="height:28px"></div>
  </div>

  <!-- Inline JS: full client-side app (uses PapaParse) -->
  <script>
  // NOTE: This script implements the same logic provided earlier.
  // It keeps area_unit default to "Sq Mt" as requested.

  const $ = id => document.getElementById(id);

  // ---- State ----
  let baseBuyers = [], baseListings = [];
  let uploadedBuyers = [], uploadedListings = [];
  let mergedBuyers = [], mergedListings = [];
  let matches = [];

  let csvRaw = [], csvColumns = [], selectedSet = new Set();
  let dataFilters = [], matchFilters = [];

  // ---- Small utilities ----
  function parseCSV(text){ return Papa.parse(text, { header:true, skipEmptyLines:true }).data; }
  function toCSV(arr){ return Papa.unparse(arr); }
  function downloadText(filename, text){
    const blob = new Blob([text], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }
  function uid(prefix='id'){ return prefix + '-' + Math.random().toString(36).slice(2,10); }

  function unitToMultiplier(unit){
    unit = (unit||'').toLowerCase();
    if(unit.includes('lakh')) return 100000;
    if(unit.includes('thousand')) return 1000;
    if(unit.includes('crore')) return 10000000;
    return 1;
  }
  function parseNumber(v){ if(v==null||v==='') return null; const n = parseFloat(String(v).replace(/[^0-9.]/g,'')); return isNaN(n)?null:n; }
  function toRupees(value, unit){ const n = parseNumber(value); if(n===null) return null; return n * unitToMultiplier(unit); }

  // ---- ID helpers (must be defined before loadDefaults runs) ----
  function nextIdFor(prefix, existingArrays) {
    const candidates = [];
    for (const arr of existingArrays || []) {
      if (!arr) continue;
      for (const r of arr) {
        if (!r) continue;
        const id = (r.id || '').toString();
        const m = id.match(new RegExp('^' + prefix + '-(\\d+)$'));
        if (m) candidates.push(parseInt(m[1], 10));
      }
    }
    const maxNum = candidates.length ? Math.max(...candidates) : 0;
    const next = (maxNum + 1);
    return `${prefix}-${String(next).padStart(3, '0')}`;
  }
  function ensureUniqueId(prefix, suppliedId, existingArrays) {
    if (!suppliedId) return nextIdFor(prefix, existingArrays);
    const idLower = suppliedId.toString();
    const exists = (existingArrays || []).some(arr => arr && arr.some(r => (r.id||'').toString() === idLower));
    if (!exists) return idLower;
    return nextIdFor(prefix, existingArrays);
  }

  // ---- Merge helpers ----
  function mergeBuyers(base, uploaded){
    const out = [...(base || [])];
    const ids = new Set((base||[]).map(b => (b.id||'').toString()));
    for(const u of (uploaded||[])){
      if(!u) continue;
      const uid = (u.id||'').toString();
      if(uid && !ids.has(uid)){ out.push(u); ids.add(uid); }
      else if(!uid){
        const key = ((u.name||'')+'|'+(u.city||'')+'|'+(u.mobile||'')).toLowerCase();
        const exists = out.some(b=>(((b.name||'')+'|'+(b.city||'')+'|'+(b.mobile||'')).toLowerCase()===key));
        if(!exists) out.push(u);
      }
    }
    return out;
  }
  function mergeListings(base, uploaded){
    const out = [...(base || [])];
    const urls = new Set((base||[]).map(l => (l.url||'').toString()));
    for(const u of (uploaded||[])){
      if(!u) continue;
      const uurl = (u.url||'').toString();
      if(uurl && !urls.has(uurl)){ out.push(u); urls.add(uurl); }
      else if(!uurl){
        const key = ((u.address||'')+'|'+(u.locality||'')+'|'+(u.price||'')).toLowerCase();
        const exists = out.some(l=>(((l.address||'')+'|'+(l.locality||'')+'|'+(l.price||'')).toLowerCase()===key));
        if(!exists) out.push(u);
      }
    }
    return out;
  }

  // ---- loadDefaults: loads /data CSVs (if present) and normalizes IDs ----
  async function loadDefaults(){
    baseBuyers = []; baseListings = [];

    try {
      const r1 = await fetch('/data/buyers.csv');
      if (r1.ok) baseBuyers = parseCSV(await r1.text());
      else console.info('/data/buyers.csv not found (HTTP ' + r1.status + ')');
    } catch(e){
      console.warn('fetch buyers.csv failed', e);
    }

    try {
      const r2 = await fetch('/data/listings.csv');
      if (r2.ok) {
        baseListings = parseCSV(await r2.text()).map(l => ({ ...l, price: parseNumber(l.price) || parseNumber(l.price_raw) || l.price }));
      } else console.info('/data/listings.csv not found (HTTP ' + r2.status + ')');
    } catch(e){ console.warn('fetch listings.csv failed', e); }

    // initial merges (uploaded arrays may be empty)
    mergedBuyers = mergeBuyers(baseBuyers, uploadedBuyers);
    mergedListings = mergeListings(baseListings, uploadedListings);

    // ensure IDs: assign sequential ids for missing/duplicate entries in base arrays
    const assignSequentialIds = (arr, prefix) => {
      const seen = new Set();
      for (let i=0;i<(arr||[]).length;i++){
        if(!arr[i].id || seen.has(arr[i].id)){
          const newId = nextIdFor(prefix, [baseBuyers, mergedBuyers, uploadedBuyers, baseListings, mergedListings, uploadedListings]);
          arr[i].id = newId;
        }
        seen.add(arr[i].id);
      }
    };
    assignSequentialIds(baseBuyers, 'buyer');
    assignSequentialIds(baseListings, 'listing');

    // recompute merged after id normalization
    mergedBuyers = mergeBuyers(baseBuyers, uploadedBuyers);
    mergedListings = mergeListings(baseListings, uploadedListings);
    console.info('loadDefaults finished. buyers=', mergedBuyers.length, 'listings=', mergedListings.length);
  }

  // ---- Robust loadCsvFile: populates csvRaw/csvColumns and calls renderCsvTable ----
  async function loadCsvFile(name){
    csvRaw = []; csvColumns = [];
    const tryPaths = [
      `/data/${name}`,
      `${window.location.pathname.replace(/\/$/, '')}/data/${name}`,
      `${window.location.origin}/data/${name}`
    ];

    // prefer in-memory (uploaded or merged)
    if (name === 'buyers.csv') {
      const source = uploadedBuyers.length ? uploadedBuyers : (mergedBuyers.length ? mergedBuyers : baseBuyers);
      if (source && source.length) {
        csvRaw = source.map((r,i) => ({ __index:i, ...r }));
        csvColumns = csvRaw.length ? Object.keys(csvRaw[0]).filter(k => k !== '__index') : [];
        renderCsvTable();
        console.log(`Loaded buyers from in-memory: ${csvRaw.length} rows`);
        return;
      }
    }
    if (name === 'listings.csv') {
      const source = uploadedListings.length ? uploadedListings : (mergedListings.length ? mergedListings : baseListings);
      if (source && source.length) {
        csvRaw = source.map((r,i) => ({ __index:i, ...r }));
        csvColumns = csvRaw.length ? Object.keys(csvRaw[0]).filter(k => k !== '__index') : [];
        renderCsvTable();
        console.log(`Loaded listings from in-memory: ${csvRaw.length} rows`);
        return;
      }
    }
    if (name === 'matches.csv') {
      const source = matches || [];
      if (source && source.length) {
        csvRaw = source.map((r,i) => ({ __index:i, ...r }));
        csvColumns = csvRaw.length ? Object.keys(csvRaw[0]).filter(k => k !== '__index') : [];
        renderCsvTable();
        console.log(`Loaded matches in-memory: ${csvRaw.length} rows`);
        return;
      }
    }

    // fetch attempts
    let lastError = null;
    for (const p of tryPaths) {
      try {
        console.log('Attempting fetch', p);
        const res = await fetch(p);
        if (!res.ok) { lastError = `HTTP ${res.status} ${res.statusText}`; console.warn(p, lastError); continue; }
        const text = await res.text();
        if (text && text.length) {
          csvRaw = parseCSV(text).map((r, i) => ({ __index: i, ...r }));
          csvColumns = csvRaw.length ? Object.keys(csvRaw[0]).filter(k => k !== '__index') : [];
          renderCsvTable();
          console.log(`Loaded ${name} from ${p} (${csvRaw.length} rows)`);
          return;
        }
      } catch (err) {
        lastError = err;
        console.error('fetch error for', p, err);
      }
    }

    const msg = `Could not load ${name}. Tried: ${tryPaths.join(', ')}. Last error: ${lastError}`;
    console.error(msg);
    alert(msg + '\nCheck that data CSVs are in /data/ and that you are serving via HTTP (not file://).');
    csvColumns = []; csvRaw = []; renderCsvTable();
  }

  // ---- CSV rendering / editing ----
  function renderCsvTable(){
    const head = $('csvHead'), body = $('csvBody');
    if(!head || !body) return;
    head.innerHTML=''; body.innerHTML='';
    if(!csvColumns.length){ head.innerHTML = '<tr><th>No data</th></tr>'; return; }
    const trh = document.createElement('tr');
    trh.innerHTML = `<th><input id="selectAll" type="checkbox" /></th>` + csvColumns.map(c=>`<th>${c}</th>`).join('') + '<th>Actions</th>';
    head.appendChild(trh);
    const selectAllEl = $('selectAll');
    if(selectAllEl) selectAllEl.addEventListener('change', e=> { if(e.target.checked) csvRaw.forEach(r=>selectedSet.add(r.__index)); else selectedSet.clear(); renderCsvTable(); });

    const filterQuick = ($('csvFilterQuick') ? $('csvFilterQuick').value : '').toLowerCase();
    csvRaw.forEach(row => {
      const rowValues = csvColumns.map(c=> (row[c]||'').toString()).join(' ').toLowerCase();
      if(filterQuick && !rowValues.includes(filterQuick)) return;
      const tr = document.createElement('tr');
      const checked = selectedSet.has(row.__index)?'checked':'';
      tr.innerHTML = `<td><input type="checkbox" data-idx="${row.__index}" ${checked}></td>` +
        csvColumns.map(c=>`<td>${(row[c]||'')}</td>`).join('') +
        `<td><button data-idx="${row.__index}" class="edit">Edit</button></td>`;
      body.appendChild(tr);
    });

    body.querySelectorAll('input[type=checkbox][data-idx]').forEach(ch=> ch.onchange = e => {
      const idx = parseInt(e.target.getAttribute('data-idx'));
      if(e.target.checked) selectedSet.add(idx); else selectedSet.delete(idx);
    });
    body.querySelectorAll('button.edit').forEach(btn=> btn.onclick = ()=> {
      const idx = parseInt(btn.getAttribute('data-idx'));
      const row = csvRaw.find(r=>r.__index===idx);
      if(!row) return;
      for(const col of csvColumns){
        const val = prompt(`Edit ${col}`, row[col]||'');
        if(val !== null) row[col] = val;
      }
      pushCsvEditsToState();
      renderCsvTable();
    });
  }

  function deleteSelectedRows(){
    if(!selectedSet.size){ alert('No selection'); return; }
    if(!confirm(`Delete ${selectedSet.size} rows?`)) return;
    csvRaw = csvRaw.filter(r => !selectedSet.has(r.__index));
    pushCsvEditsToState();
    selectedSet.clear();
    renderCsvTable();
  }

  function downloadCurrentCsv(){
    const out = csvRaw.map(r=> {
      const obj = {}; csvColumns.forEach(c => obj[c] = r[c] || ''); return obj;
    });
    downloadText($('csvSelect').value || 'data.csv', toCSV(out));
  }

  function pushCsvEditsToState(){
    const name = $('csvSelect').value;
    const rows = csvRaw.map(r => { const obj={}; csvColumns.forEach(c=> obj[c]=r[c]||''); return obj; });
    if(name === 'buyers.csv'){
      if(uploadedBuyers.length) uploadedBuyers = rows; else mergedBuyers = rows;
    } else if(name === 'listings.csv'){
      if(uploadedListings.length) uploadedListings = rows; else mergedListings = rows;
    } else if(name === 'matches.csv'){
      matches = rows;
    }
  }

  // ---- Matcher logic ----
  function runMatcher(buyersArr, listingsArr, minScore=60){
    const out = [];
    const listingsNormalized = (listingsArr||[]).map(l => ({ ...l, _text: ((l.description||'') + ' ' + (l.address||'') + ' ' + (l.project||'') + ' ' + (l.locality||'')).toLowerCase() }));
    for(const b of (buyersArr||[])){
      const bId = b.id||uid('buyer');
      const minP = b.budget_rupees || parseNumber(b.budget_raw) || 0;
      const loc = (b.city || b.locality || b.state || b.preferred_localities || '').toString().toLowerCase();
      const keywords = (b.preferred_localities || b.preferred_projects || b.property_type || b.specific || '').toString().toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
      for(const l of listingsNormalized){
        let score = 0;
        const lp = parseNumber(l.price) || parseNumber(l.price_raw) || 0;
        if(lp && minP){
          if(Math.abs(lp - minP) / Math.max(1, minP) < 0.2) score += 50;
          else {
            const diff = Math.abs(lp - minP);
            const denom = Math.max(1, Math.max(lp, minP));
            score += Math.max(0, 50 - (diff/denom)*50);
          }
        } else if(lp && !minP) score += 10;
        if(loc && ((l.locality||'') + ' ' + (l.address||'') + ' ' + (l.state||'')).toLowerCase().includes(loc)) score += 25;
        for(const kw of keywords) if(kw && l._text.includes(kw)) score += 20;
        if(score > 0){
          const sc = Math.min(100, Math.round(score));
          if(sc >= minScore) out.push({
            buyer_id: bId, buyer_name: b.name||'', listing_id: l.id||'', listing_title: l.project||l.address||l.description||'', listing_price: lp, listing_location: l.locality||l.state||'', listing_url: l.url||'', score: sc
          });
        }
      }
    }
    out.sort((a,b)=> a.buyer_id < b.buyer_id ? -1 : (a.buyer_id > b.buyer_id ? 1 : b.score - a.score));
    return out;
  }

  // ---- Filters helper (UI builder + apply functions) ----
  const OPERATORS = [
    { v: 'contains', label: 'contains' },
    { v: 'equals', label: 'equals' },
    { v: 'starts', label: 'starts with' },
    { v: 'ends', label: 'ends with' },
    { v: 'gt', label: '>' },
    { v: 'lt', label: '<' },
    { v: 'gte', label: '>=' },
    { v: 'lte', label: '<=' }
  ];

  function createFilterRow(container, columns, filtersArray) {
    const row = document.createElement('div'); row.className='filter-row';
    const colSel = document.createElement('select');
    columns.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; colSel.appendChild(opt); });
    const opSel = document.createElement('select');
    OPERATORS.forEach(o => { const opt = document.createElement('option'); opt.value = o.v; opt.textContent = o.label; opSel.appendChild(opt); });
    const valInp = document.createElement('input'); valInp.placeholder = 'value';
    const ci = document.createElement('label'); ci.style.fontSize='12px'; ci.style.color='#6b7280';
    const ciCheckbox = document.createElement('input'); ciCheckbox.type = 'checkbox'; ciCheckbox.checked = true; ci.appendChild(ciCheckbox); ci.appendChild(document.createTextNode(' ci'));
    const rem = document.createElement('button'); rem.textContent = 'Remove'; rem.style.background = '#ef4444'; rem.style.color='white'; rem.style.border='none'; rem.style.padding='6px 8px'; rem.style.borderRadius='6px';
    row.appendChild(colSel); row.appendChild(opSel); row.appendChild(valInp); row.appendChild(ci); row.appendChild(rem); container.appendChild(row);
    const rule = { column: colSel.value, op: opSel.value, value: '', caseInsensitive: ciCheckbox.checked };
    filtersArray.push(rule);
    colSel.onchange = () => { rule.column = colSel.value; };
    opSel.onchange = () => { rule.op = opSel.value; };
    valInp.oninput = () => { rule.value = valInp.value; };
    ciCheckbox.onchange = () => { rule.caseInsensitive = ciCheckbox.checked; };
    rem.onclick = () => {
      const i = filtersArray.indexOf(rule);
      if (i >= 0) filtersArray.splice(i, 1);
      container.removeChild(row);
    };
  }

  function predicateForRule(rule) {
    const col = rule.column; const op = rule.op; const valRaw = rule.value; const ci = rule.caseInsensitive;
    return function(item) {
      let left = (item[col] === undefined || item[col] === null) ? '' : String(item[col]);
      let right = String(valRaw);
      if (ci) { left = left.toLowerCase(); right = right.toLowerCase(); }
      const leftNum = parseFloat(left.replace(/[^0-9.\-]/g,'')); const rightNum = parseFloat(right.replace(/[^0-9.\-]/g,''));
      const numericPossible = !isNaN(leftNum) && !isNaN(rightNum);
      switch(op) {
        case 'contains': return left.includes(right);
        case 'equals': return left === right;
        case 'starts': return left.startsWith(right);
        case 'ends': return left.endsWith(right);
        case 'gt': return numericPossible ? (leftNum > rightNum) : (left > right);
        case 'lt': return numericPossible ? (leftNum < rightNum) : (left < right);
        case 'gte': return numericPossible ? (leftNum >= rightNum) : (left >= right);
        case 'lte': return numericPossible ? (leftNum <= rightNum) : (left <= right);
        default: return false;
      }
    };
  }
  function applyFilters(arr, filtersArray, mode = 'and') {
    if (!filtersArray || !filtersArray.length) return arr;
    const preds = filtersArray.map(predicateForRule);
    if (mode === 'and') return arr.filter(item => preds.every(p => p(item)));
    return arr.filter(item => preds.some(p => p(item)));
  }

  // ---- DOM wiring: single place ----
  window.addEventListener('DOMContentLoaded', async () => {
    // load defaults first
    await loadDefaults();

    // Navigation buttons
    function showPage(name){
      ['buyers','listings','data','matches'].forEach(p=> {
        const el = document.getElementById('page-' + p);
        if(el) el.style.display = (p === name) ? 'block':'none';
        document.querySelectorAll('nav button').forEach(btn => btn.classList.toggle('active', btn.getAttribute('data-route') === name));
      });
    }
    document.querySelectorAll('nav button').forEach(btn => btn.onclick = ()=> showPage(btn.getAttribute('data-route')));
    showPage('buyers');

    // Buyer add
    const addBuyerBtn = $('addBuyer');
    if(addBuyerBtn) addBuyerBtn.onclick = () => {
      const existingForIds = [baseBuyers, mergedBuyers, uploadedBuyers];
      const suppliedId = ''; // no manual id input in UI
      const id = ensureUniqueId('buyer', suppliedId, existingForIds);
      const rec = {
        id,
        name: $('buyer_name').value.trim(),
        mobile: $('buyer_mobile').value.trim(),
        mobile2: $('buyer_mobile2').value.trim(),
        email: $('buyer_email').value.trim(),
        country: $('buyer_country').value.trim(),
        state: $('buyer_state').value.trim(),
        city: $('buyer_city').value.trim(),
        service_type: $('buyer_service_type').value.trim(),
        property_type: $('buyer_property_type').value.trim(),
        sale_type: $('buyer_sale_type').value.trim(),
        furnishing: $('buyer_furnishing').value.trim(),
        possession_status: $('buyer_possession_status').value.trim(),
        possession_time: $('buyer_possession_time').value.trim(),
        budget_raw: $('buyer_budget').value.trim(),
        budget_unit: ($('buyer_budget_unit')?$('buyer_budget_unit').value:'lakh'),
        budget_rupees: toRupees($('buyer_budget').value.trim(), ($('buyer_budget_unit')?$('buyer_budget_unit').value:'lakh')),
        area: $('buyer_area').value.trim(),
        area_unit: ($('buyer_area_unit')?$('buyer_area_unit').value:'Sq Mt'),
        preferred_localities: $('buyer_localities').value.trim(),
        preferred_projects: $('buyer_projects').value.trim(),
        lead_source: $('buyer_lead_source').value.trim(),
        referral: $('buyer_referral').value.trim(),
        nri: ($('buyer_nri')?$('buyer_nri').value:'no'),
        loan_required: ($('buyer_loan_required')?$('buyer_loan_required').value:'no'),
        purpose: ($('buyer_purpose')?$('buyer_purpose').value:''),
        specific: $('buyer_specific').value.trim()
      };
      if(!rec.name || !rec.mobile){ alert('Buyer name and mobile are required'); return; }
      uploadedBuyers.push(rec);
      mergedBuyers = mergeBuyers(baseBuyers, uploadedBuyers);
      alert(`Buyer added (id=${id}). It will be included in merge & match.`);
      // clear fields
      ['buyer_name','buyer_mobile','buyer_mobile2','buyer_email','buyer_state','buyer_city','buyer_property_type','buyer_budget','buyer_area','buyer_localities','buyer_projects','buyer_lead_source','buyer_referral','buyer_specific'].forEach(id => { if($(id)) $(id).value = ''; });
    };

    // Buyer download
    const downloadBuyersBtn = $('downloadBuyers');
    if(downloadBuyersBtn) downloadBuyersBtn.onclick = () => {
      const arr = mergeBuyers(baseBuyers, uploadedBuyers);
      downloadText('buyers.csv', toCSV(arr));
    };

    // Listing add
    const addListingBtn = $('addListing');
    if(addListingBtn) addListingBtn.onclick = () => {
      const existingForIds = [baseListings, mergedListings, uploadedListings];
      const suppliedId = '';
      const id = ensureUniqueId('listing', suppliedId, existingForIds);
      const rec = {
        id,
        deal_type: ($('listing_deal_type')?$('listing_deal_type').value:'Sell'),
        furnishing: ($('listing_furnishing')?$('listing_furnishing').value:''),
        property_type: $('listing_property_type').value.trim(),
        bedrooms: $('listing_bedrooms').value.trim(),
        state: $('listing_state').value.trim(),
        locality: $('listing_locality').value.trim(),
        google_address: $('listing_google_address').value.trim(),
        project: $('listing_project').value.trim(),
        address: $('listing_address').value.trim(),
        area: $('listing_area').value.trim(),
        area_unit: ($('listing_area_unit')?$('listing_area_unit').value:'Sq Mt'),
        price_raw: $('listing_price').value.trim(),
        price_unit: ($('listing_price_unit')?$('listing_price_unit').value:'Lakh'),
        price: toRupees($('listing_price').value.trim(), ($('listing_price_unit')?$('listing_price_unit').value:'Lakh')),
        deposit_raw: $('listing_deposit').value.trim(),
        deposit_unit: ($('listing_deposit_unit')?$('listing_deposit_unit').value:'Lakh'),
        deposit: toRupees($('listing_deposit').value.trim(), ($('listing_deposit_unit')?$('listing_deposit_unit').value:'Lakh')),
        contact: $('listing_contact').value.trim(),
        url: $('listing_url').value.trim(),
        description: $('listing_description').value.trim()
      };
      if(!rec.address || !rec.description){ alert('Listing address and description required'); return; }
      uploadedListings.push(rec);
      mergedListings = mergeListings(baseListings, uploadedListings);
      alert(`Listing added (id=${id}). It will be included in merge & match.`);
      ['listing_address','listing_description','listing_price','listing_area','listing_contact','listing_url','listing_bedrooms','listing_project','listing_google_address'].forEach(id => { if($(id)) $(id).value = ''; });
    };

    // Listing download
    const downloadListingsBtn = $('downloadListings');
    if(downloadListingsBtn) downloadListingsBtn.onclick = () => {
      const arr = mergeListings(baseListings, uploadedListings);
      // ensure area_unit default
      const normalized = arr.map(l => ({ ...l, area_unit: l.area_unit || 'Sq Mt' }));
      downloadText('listings.csv', toCSV(normalized));
    };

    // Data page buttons
    const refreshCsv = $('refreshCsv');
    if(refreshCsv) refreshCsv.onclick = async ()=> loadCsvFile($('csvSelect').value);
    const deleteBtn = $('deleteSelected'); if(deleteBtn) deleteBtn.onclick = ()=> deleteSelectedRows();
    const downloadCsvBtn = $('downloadCsv'); if(downloadCsvBtn) downloadCsvBtn.onclick = ()=> downloadCurrentCsv();

    // Uploads for Matches page
    const uploadBuyers = $('uploadBuyers');
    if(uploadBuyers) uploadBuyers.onchange = async e => {
      const f = e.target.files[0]; if(!f) return;
      uploadedBuyers = parseCSV(await f.text());
      uploadedBuyers = uploadedBuyers.map(b => ({ ...b, budget_rupees: toRupees(b.budget_raw||b.budget, b.budget_unit||'lakh') }));
      alert('Uploaded buyers: ' + uploadedBuyers.length);
    };
    const uploadListings = $('uploadListings');
    if(uploadListings) uploadListings.onchange = async e => {
      const f = e.target.files[0]; if(!f) return;
      uploadedListings = parseCSV(await f.text());
      uploadedListings = uploadedListings.map(l => ({ ...l, price: toRupees(l.price_raw||l.price, l.price_unit||'lakh'), area: parseNumber(l.area), area_unit: l.area_unit || 'Sq Mt' }));
      alert('Uploaded listings: ' + uploadedListings.length);
    };

    // Merge & run
    const mergeAndRunBtn = $('mergeAndRun');
    if(mergeAndRunBtn) mergeAndRunBtn.onclick = async () => {
      await loadDefaults();
      mergedBuyers = mergeBuyers(baseBuyers, uploadedBuyers);
      mergedListings = mergeListings(baseListings, uploadedListings);
      const minScore = parseFloat($('minScore').value) || 60;
      matches = runMatcher(mergedBuyers, mergedListings, minScore);
      renderMatches(matches);
      alert('Matcher ran — results: ' + matches.length);
    };

    // download matches
    const downloadMatchesBtn = $('downloadMatchesBtn'); if(downloadMatchesBtn) downloadMatchesBtn.onclick = ()=> downloadText('matches.csv', toCSV(matches || []));

    // setup Filters UI wiring (Data and Matches)
    const addDataBtn = $('addDataFilterBtn');
    const dataFiltersContainer = $('dataFiltersContainer');
    const applyDataFiltersBtn = $('applyDataFilters');
    const clearDataFiltersBtn = $('clearDataFilters');
    const dataFilterModeSel = $('dataFilterMode');

    if(addDataBtn) addDataBtn.addEventListener('click', () => {
      const csvName = $('csvSelect').value;
      let columns = [];
      if (csvName === 'buyers.csv') columns = (mergedBuyers[0]) ? Object.keys(mergedBuyers[0]) : [];
      else if (csvName === 'listings.csv') columns = (mergedListings[0]) ? Object.keys(mergedListings[0]) : [];
      else if (csvName === 'matches.csv') columns = (matches[0]) ? Object.keys(matches[0]) : [];
      else columns = csvColumns || [];
      if (!columns || !columns.length) { alert('No columns available to filter. Load a CSV first.'); return; }
      createFilterRow(dataFiltersContainer, columns, dataFilters);
    });

    if(applyDataFiltersBtn) applyDataFiltersBtn.addEventListener('click', () => {
      const mode = dataFilterModeSel ? dataFilterModeSel.value : 'and';
      if (!csvRaw || !csvRaw.length) { alert('No table loaded. Click Load CSV first.'); return; }
      const baseArray = csvRaw.map(r => { const obj = {}; csvColumns.forEach(c => obj[c] = r[c] || ''); return obj; });
      const filtered = applyFilters(baseArray, dataFilters, mode);
      csvRaw = filtered.map((r, i) => ({ __index: i, ...r }));
      renderCsvTable();
    });

    if(clearDataFiltersBtn) clearDataFiltersBtn.addEventListener('click', () => {
      dataFilters = []; if(dataFiltersContainer) dataFiltersContainer.innerHTML = '';
      loadCsvFile($('csvSelect').value);
    });

    // Matches filter wiring
    const addMatchBtn = $('addMatchFilterBtn');
    const matchFiltersContainer = $('matchFiltersContainer');
    const applyMatchFiltersBtn = $('applyMatchFilters');
    const clearMatchFiltersBtn = $('clearMatchFilters');
    const matchFilterModeSel = $('matchFilterMode');

    if(addMatchBtn) addMatchBtn.addEventListener('click', () => {
      const example = matches && matches.length ? matches[0] : (mergedListings && mergedListings.length ? mergedListings[0] : {});
      const columns = example ? Object.keys(example) : [];
      if (!columns.length) { alert('Run the matcher first to get columns to filter.'); return; }
      createFilterRow(matchFiltersContainer, columns, matchFilters);
    });

    if(applyMatchFiltersBtn) applyMatchFiltersBtn.addEventListener('click', () => {
      const mode = matchFilterModeSel ? matchFilterModeSel.value : 'and';
      const smin = parseFloat($('matchScoreMin').value || '0');
      const smax = parseFloat($('matchScoreMax').value || '100');
      let filtered = matches.slice();
      if (matchFilters.length) filtered = applyFilters(filtered, matchFilters, mode);
      filtered = filtered.filter(m => {
        const sc = parseFloat(m.score || 0); return sc >= smin && sc <= smax;
      });
      renderMatches(filtered);
    });

    if(clearMatchFiltersBtn) clearMatchFiltersBtn.addEventListener('click', () => {
      matchFilters = []; if(matchFiltersContainer) matchFiltersContainer.innerHTML = '';
      renderMatches(matches || []);
    });

    // default: set csvSelect and hook load
    if($('csvSelect')) $('csvSelect').value = 'buyers.csv';
    if($('refreshCsv')) $('refreshCsv').click();
  });

  // ---- renderMatches (keeps same look) ----
  function renderMatches(ms){
    const cont = $('matchesContainer'); if(!cont) return;
    cont.innerHTML='';
    if(!ms || !ms.length){ cont.innerHTML = '<div class="muted">No matches yet</div>'; return; }
    const grouped = {};
    ms.forEach(m => { grouped[m.buyer_id] = grouped[m.buyer_id] || { buyer_name: m.buyer_name, rows: [] }; grouped[m.buyer_id].rows.push(m); });
    for(const bid of Object.keys(grouped)){
      const g = grouped[bid];
      const card = document.createElement('div'); card.className='card'; card.style.marginBottom='12px';
      card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${g.buyer_name||'(unnamed)'}</strong><div class="muted">Buyer ID: ${bid}</div></div><div class="muted">${g.rows.length} matches</div></div>`;
      const grid = document.createElement('div'); grid.className='listings-grid';
      g.rows.forEach(r => {
        const li = document.createElement('div'); li.className='listing';
        li.innerHTML = `<div><a href="${r.listing_url||'#'}" target="_blank">${r.listing_title||'Listing'}</a> — <strong>₹${r.listing_price||''}</strong></div><div class="muted">${r.listing_location||''}</div><div style="margin-top:6px">Score: <strong>${r.score}</strong></div>`;
        grid.appendChild(li);
      });
      card.appendChild(grid); cont.appendChild(card);
    }
  }
  </script>
</body>
</html>
